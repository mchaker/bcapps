<link rel="stylesheet" href="MAPS/leaflet.css" />
<script src="MAPS/leaflet.js"></script>
<script src="bclib.js"></script>

<style>html,body, #map {height:100%;}</style>
<div id="map"></div>

<script>

/*

Place equirectangular tilesfrom an image on a Leaflet "map" (canvas?) 
given the following in a hash:

map: put the tiles here

tileURL: template for tile URLs

minZoom: never get tiles lower than this zoom level

maxZoom: never get tiles higher than this zoom level

opacity; tile opacity

fake: if set to 1, don't do anything, just print out debugging info

document function here more

*/

function placeImageTilesOnMap(obj) {

  // defaults

  obj = mergeHashes(obj, str2hash("minZoom=0&maxZoom=999&opacity=1"));

  let z = obj.map.getZoom();
  var url;

  let mapBounds = obj.map.getBounds();

  // TODO: this could be functionalized

  // TODO: consider toBBoxString here
  // TODO: images are assumed equirectangular projected for now

  let n = boundNumber(mapBounds.getNorth(), -90, 90);
  let s = boundNumber(mapBounds.getSouth(), -90, 90);
  let e = boundNumber(mapBounds.getEast(), -180, 180);
  let w = boundNumber(mapBounds.getWest(), -180, 180);

  let nw = lngLat2ImageTile(mergeHashes(obj, {lat: n, lng: w, z: z}));
  let se = lngLat2ImageTile(mergeHashes(obj, {lat: s, lng: e, z: z}));

  for (let i = Math.floor(nw.x); i <= Math.floor(se.x); i++) {
    for (let j = Math.floor(se.y); j <= Math.floor(nw.y); j++) {

      let bounds0 = imageTile2LngLat(mergeHashes(obj, {z: z, x: i, y: j}));
      let bounds1 = imageTile2LngLat(mergeHashes(obj, {z: z, x: i+1, y: j+1}));
      url = convertStringTemplate(obj.tileURL, {x: i, y: j, z: z});

            L.imageOverlay(url, [bounds0, bounds1], 
      			   {opacity: obj.opacity}).addTo(obj.map);

    }
  }
}

let map = L.map('map', {crs: L.CRS.Simple});
map.fitBounds([[-90, -180], [90, 180]]);
// map.flyTo([25.8, -79.1], 7);
map.on('zoomend', redraw_map);
map.on('moveend', redraw_map);
// can't set zoom from 3 to 6 for some reason?!@?!
map.setView([25.8, -79.1], 7);
redraw_map();


// for testing, set to Florida

// TODO: pass image base too

function redraw_map() {

  // TODO: not this
  map.eachLayer(function(layer) {layer.remove()});

  // testing

  //  placeImageTilesOnMap({map: map, opacity: 1, width: 43200,
  //	height: 21600, origTileZoom: 8,
  //	tileURL: 'http://ws.terramapadventure.com/CLIMATE/${z}/${x}/${y}.png'
  //	});

  placeImageTilesOnMap({map: map, opacity: 1, width: 129600,
	height: 64800, origTileZoom: 9,
	tileURL: 'http://ws.terramapadventure.com/LANDUSE/${z}/${x}/${y}.png'
	});

  return;

  
  // climate map on new server
  placeTilesOnMap({map: map, projection: 1, opacity: 1, fake: 1,
	tileURL: "http://ws.terramapadventure.com/CLIMATE/${z}/${x}/${y}.png"
	});


  // climate map on new server
  placeTilesOnMap({map: map, projection: 1, opacity: 1,
	tileURL: "http://ws.terramapadventure.com/LANDUSE/${z}/${x}/${y}.png"
	});


return;

//  hack_beck2_tiles({map: map, opacity: 0.5});

  // my coord map

  placeTilesOnMap({map: map, projection: 1, opacity: 0.5,
	tileURL: "http://test.barrycarter.info/bc-mytile3.pl?/${z}/${x}/${y}.png"
	});

  // the OSM map
  placeTilesOnMap({map: map, projection: 1, opacity: 0.5,
	tileURL: "https://a.tile.openstreetmap.org/${z}/${x}/${y}.png"
	});

  // probably not working Beck climate map
  //  placeTilesOnMap({map: map, projection: 0, opacity: 0.5,
  //	tileURL: "http://test.barrycarter.info/BECK/${z}/beck_${x}_${y}.png"
  //	});

}



// applyFunctionToHashValues({hash: {a: 1.6, b: 2.4, c:3.7 }, f: Math.floor});

</script>
