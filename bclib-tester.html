<link rel="stylesheet" href="MAPS/leaflet.css" />
<script src="MAPS/leaflet.js"></script>
<script src="bclib.js"></script>

<style>html,body, #map {height:100%;}</style>
<div id="map"></div>

<script>

/*

Place equirectangular tilesfrom an image on a Leaflet "map" (canvas?) 
given the following in a hash:

map: put the tiles here

tileURL: template for tile URLs

minZoom: never get tiles lower than this zoom level

maxZoom: never get tiles higher than this zoom level

opacity; tile opacity

fake: if set to 1, don't do anything, just print out debugging info

TODO: document function here more

*/

function placeImageTilesOnMap(obj) {

  // defaults

  obj = mergeHashes(obj, str2hash("minZoom=0&maxZoom=999&opacity=1"));

  // do nothing if requested

  if (obj.fake) {return;}

  let z = boundNumber(obj.map.getZoom(), obj.minZoom, obj.maxZoom);
  let mapBounds = obj.map.getBounds().toBBoxString();
  let bounds = mapBounds.split(",").map(parseFloat);

  //  lngLatRange2ImageTiles(obj);

  let [w, s, e, n] = bounds;

  // NOTE: testing lngLatRange2ImageTiles()

  //  return;

  // TODO: this could be functionalized

  // TODO: consider toBBoxString here

  // NOTE: not bounding east/west longitudes in hopes of achieving toroidality

  //  let n = boundNumber(mapBounds.getNorth(), -90, 90);
  //  let s = boundNumber(mapBounds.getSouth(), -90, 90);
  //  let e = mapBounds.getEast();
  //  let w = mapBounds.getWest();

  let nw = lngLat2ImageTile(mergeHashes(obj, {lat: n, lng: w, z: z}));
  let se = lngLat2ImageTile(mergeHashes(obj, {lat: s, lng: e, z: z}));

  td([se, nw], "nw");

  for (let i = Math.floor(nw.x); i <= Math.floor(se.x); i++) {
    for (let j = Math.floor(se.y); j <= Math.floor(nw.y); j++) {

      td([i,j], "IJ");

      let bounds0 = imageTile2LngLat(mergeHashes(obj, {z: z, x: i, y: j}));
      let bounds1 = imageTile2LngLat(mergeHashes(obj, {z: z, x: i+1, y: j+1}));

      // for the URL, mod i by maximum possible value

      // this is the higest possible value for x at this zoom level

      //      td(obj.width*2**(z-obj.origTileZoom-8), "HMMM");
      // let maxX = Math.floor(obj.width*2**(z-obj.origTileZoom-8));

      //      let tileI = i.mod(maxX);
      //      td([maxX, i, tileI], "ALPHA");

      let url = convertStringTemplate(obj.tileURL, {x: i, y: j, z: z});
      td(url, "URL");
      L.imageOverlay(url, [bounds0, bounds1], 
      			   {opacity: obj.opacity}).addTo(obj.map);

    }
  }
}

let map = L.map('map', {crs: L.CRS.Simple});
map.fitBounds([[-90, -180], [90, 180]]);
// map.flyTo([25.8, -79.1], 7);
map.on('zoomend', redraw_map);
map.on('moveend', redraw_map);
// can't set zoom from 3 to 6 for some reason?!@?!
map.setView([25.8, -79.1], 7);
redraw_map();


// for testing, set to Florida

// TODO: pass image base too

function redraw_map() {

  // TODO: not this
  map.eachLayer(function(layer) {layer.remove()});

  // the OSM map (comes first so others can overlay)

  placeTilesOnMap({map: map, projection: 1, opacity: 1, minZoom: 4,
	tileURL: "https://a.tile.openstreetmap.org/${z}/${x}/${y}.png"
	});


  // informative tile grid
  placeTilesOnMap({map: map, projection: 1, opacity: 0.5, fake: 1,
	tileURL: "http://test.barrycarter.info/bc-mytile3.pl?/${z}/${x}/${y}.png"
	});

  // climate map
  placeImageTilesOnMap({map: map, opacity: 1, width: 43200,
  	height: 21600, origTileZoom: 8, opacity: 0.5, maxZoom: 8, fake: 1,
  	tileURL: 'http://ws.terramapadventure.com/CLIMATE/${z}/${x}/${y}.png'
  	});

  // landuse map
  placeImageTilesOnMap({map: map, opacity: 0.5, width: 129600, fake: 0,
	height: 64800, origTileZoom: 9, maxZoom: 9,
	tileURL: 'http://ws.terramapadventure.com/LANDUSE/${z}/${x}/${y}.png'
	});

}

</script>
